<app-messages></app-messages>

<div class="admin-container">
  <div class="admin-header">
    <div class="header-content">
      <div style="display: flex; align-items: center; gap: 20px;">
        <!-- Swissgliders Logo -->
        <img src="assets/images/swissgliders-logo.png" alt="Swissgliders Logo" style="width: 50px; height: 50px;">
        <div>
          <h1>ğŸ‘‘ Admin Dashboard</h1>
          <p>Ãœbersicht aller Benutzer und RettungsgerÃ¤te</p>
        </div>
      </div>
      <div class="header-actions">
        <button (click)="goToUserDashboard()" class="btn-secondary">ğŸª‚ Meine RettungsgerÃ¤te</button>
        <button (click)="logout()" class="btn-secondary">Abmelden</button>
      </div>
    </div>
  </div>

  <div class="admin-content">
    <!-- Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-info">
          <div class="stat-value">{{ activeUsers$ | async }}/{{ (users$ | async)?.length || 0 }}</div>
          <div class="stat-label">Aktive Benutzer</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸª‚</div>
        <div class="stat-info">
          <div class="stat-value">{{ activeDevices$ | async }}/{{ totalDevices$ | async }}</div>
          <div class="stat-label">Aktive RettungsgerÃ¤te</div>
        </div>
      </div>
      <div class="stat-card stat-warning">
        <div class="stat-icon">âš ï¸</div>
        <div class="stat-info">
          <div class="stat-value">{{ upcomingDevices$ | async }}</div>
          <div class="stat-label">Bald fÃ¤llig</div>
        </div>
      </div>
      <div class="stat-card stat-danger">
        <div class="stat-icon">ğŸš¨</div>
        <div class="stat-info">
          <div class="stat-value">{{ overdueDevices$ | async }}</div>
          <div class="stat-label">ÃœberfÃ¤llig</div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button [class.active]="activeTab === 'devices'" (click)="switchTab('devices')" class="tab-button">
        ğŸª‚ Alle RettungsgerÃ¤te ({{ (devices$ | async)?.length || 0 }})
      </button>
      <button [class.active]="activeTab === 'users'" (click)="switchTab('users')" class="tab-button">
        ğŸ‘¥ Benutzer ({{ (users$ | async)?.length || 0 }})
      </button>
      <button [class.active]="activeTab === 'settings'" (click)="switchTab('settings')" class="tab-button">
        âš™ï¸ Einstellungen
      </button>
    </div>

    <!-- Devices Tab -->
    @if (activeTab === 'devices') {
      <div class="tab-content">
        <div class="filter-bar">
          <label>Filter nach Benutzer:</label>
          <select (change)="filterByUser($any($event.target).value ? +$any($event.target).value : null)" class="filter-select">
            <option [value]="null">Alle Benutzer</option>
            @for (user of users$ | async; track user.id) {
              <option [value]="user.id">{{ user.first_name }} {{ user.last_name }} ({{ user.device_count }})</option>
            }
          </select>
        </div>

        @if (isLoadingDevices$ | async) {
          <div class="loading">Lade RettungsgerÃ¤te...</div>
        } @else if ((filteredDevices$ | async)?.length === 0) {
          <div class="empty-state"><p>Keine RettungsgerÃ¤te gefunden</p></div>
        } @else {
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>GerÃ¤t</th>
                  <th>Seriennummer</th>
                  <th>Benutzer</th>
                  <th>Zuletzt gepackt</th>
                  <th>NÃ¤chste ÃœberprÃ¼fung</th>
                  <th>Intervall</th>
                  <th>Erinnerung</th>
                  <th>Status</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody>
                @for (device of filteredDevices$ | async; track device.id) {
                  <tr [class]="getStatusClass(device)">
                    <td class="device-name">
                      {{ device.device_name }}
                      @if (device.notes) {
                        <span class="has-notes" title="{{ device.notes }}">ğŸ“</span>
                      }
                    </td>
                    <td class="serial-cell">
                      @if (device.serial_number) {
                        <code>{{ device.serial_number }}</code>
                      } @else {
                        <span class="text-muted">-</span>
                      }
                    </td>
                    <td>
                      <div class="user-info">
                        <div class="user-name">{{ device.user_first_name }} {{ device.user_last_name }}</div>
                        <div class="user-email">{{ device.user_email }}</div>
                        @if (!device.user_is_active) {
                          <span class="badge-inactive">Inaktiv</span>
                        }
                      </div>
                    </td>
                    <td>{{ device.last_packed | date: 'dd.MM.yyyy' }}</td>
                    <td>{{ getNextDueDate(device) | date: 'dd.MM.yyyy' }}</td>
                    <td>{{ device.reminder_interval }} Monate</td>
                    <td>
                      @if (device.reminder_enabled) {
                        <span class="badge-active">Ein</span>
                      } @else {
                        <span class="badge-inactive">Aus</span>
                      }
                    </td>
                    <td><span class="status-badge">{{ getStatusText(device) }}</span></td>
                    <td class="actions-cell">
                      <button (click)="openEditDevice(device)" class="btn-icon-small">âœï¸</button>
                      <button (click)="deleteDevice(device)" class="btn-icon-small btn-danger">ğŸ—‘ï¸</button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    }

    <!-- Users Tab -->
    @if (activeTab === 'users') {
      <div class="tab-content">
        @if (isLoadingUsers$ | async) {
          <div class="loading">Lade Benutzer...</div>
        } @else if ((users$ | async)?.length === 0) {
          <div class="empty-state"><p>Noch keine Benutzer registriert</p></div>
        } @else {
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Rolle</th>
                  <th>Status</th>
                  <th>RettungsgerÃ¤te</th>
                  <th>Registriert</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody>
                @for (user of users$ | async; track user.id) {
                  <tr>
                    <td class="user-name-cell">{{ user.first_name }} {{ user.last_name }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                      @if (user.is_admin) {
                        <span class="role-badge admin">Admin</span>
                      } @else {
                        <span class="role-badge user">Benutzer</span>
                      }
                    </td>
                    <td>
                      @if (user.is_active) {
                        <span class="badge-active">Aktiv</span>
                      } @else {
                        <span class="badge-inactive">Inaktiv</span>
                      }
                    </td>
                    <td class="text-center">
                      @if (user.device_count > 0) {
                        <button (click)="viewUserDevices(user)" class="device-count-btn">{{ user.device_count }}</button>
                      } @else {
                        <span class="text-muted">0</span>
                      }
                    </td>
                    <td>{{ user.created_at | date: 'dd.MM.yyyy' }}</td>
                    <td class="actions-cell">
                      @if (!user.is_admin) {
                        <button (click)="openEditUser(user)" class="btn-icon-small" title="Email Ã¤ndern">âœ‰ï¸</button>
                        <button (click)="toggleUserActive(user)" class="btn-icon-small" [title]="user.is_active ? 'Deaktivieren' : 'Aktivieren'">
                          @if (user.is_active) {<span>â¸ï¸</span>} @else {<span>â–¶ï¸</span>}
                        </button>
                        <button (click)="deleteUser(user)" class="btn-icon-small btn-danger" title="LÃ¶schen">ğŸ—‘ï¸</button>
                      } @else {
                        <span class="text-muted">Admin</span>
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    }

    <!-- Settings Tab -->
    @if (activeTab === 'settings') {
      <div class="tab-content">
        <div class="settings-panel">
          <h2>ğŸ”§ Email-Einstellungen</h2>
          
          <div class="setting-box">
            <h3>Verbindung testen</h3>
            <p>PrÃ¼fen Sie, ob die SMTP-Konfiguration korrekt ist.</p>
            <button (click)="testEmailConnection()" [disabled]="isTestingEmail" class="btn-primary">
              ğŸ” Verbindung testen
            </button>
            @if (emailTestResult) {
              <div class="test-result">{{ emailTestResult }}</div>
            }
          </div>

          <div class="setting-box">
            <h3>Test-Email senden</h3>
            <p>Senden Sie eine Test-Email an eine beliebige Adresse.</p>
            <div class="email-test-group">
              <input type="email" [(ngModel)]="testEmailAddress" placeholder="test@example.com" class="form-control" />
              <button (click)="sendTestEmail()" [disabled]="isTestingEmail" class="btn-primary">
                ğŸ“¤ Test-Email senden
              </button>
            </div>
          </div>

          <div class="setting-box info-box">
            <h3>â„¹ï¸ SMTP-Konfiguration</h3>
            <p>Die SMTP-Einstellungen werden in der Datei <code>backend/src/services/emailService.ts</code> konfiguriert.</p>
            <p>FÃ¼r Gmail: Erstellen Sie ein App-Passwort unter Google-Konto â†’ Sicherheit â†’ 2-Faktor-Authentifizierung â†’ App-PasswÃ¶rter</p>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Modal: Edit Device -->
  @if (showEditDeviceModal && editingDevice) {
    <div class="modal-overlay" (click)="closeEditDeviceModal()">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>GerÃ¤t bearbeiten</h2>
          <button (click)="closeEditDeviceModal()" class="btn-close">âœ•</button>
        </div>

        <form (ngSubmit)="onUpdateDevice()" #deviceFormElem="ngForm">
          <div class="form-info">
            <strong>Benutzer:</strong> {{ editingDevice.user_first_name }} {{ editingDevice.user_last_name }} ({{ editingDevice.user_email }})
          </div>

          <div class="form-group">
            <label>GerÃ¤tename *</label>
            <input type="text" name="name" [(ngModel)]="deviceForm.name" required #name="ngModel" class="form-control" />
          </div>

          <div class="form-group">
            <label>Seriennummer</label>
            <input type="text" name="serial_number" [(ngModel)]="deviceForm.serial_number" class="form-control" />
          </div>

          <div class="form-group">
            <label>Zuletzt gepackt *</label>
            <input type="date" name="last_packed" [(ngModel)]="deviceForm.last_packed" required class="form-control" />
          </div>

          <div class="form-group">
            <label>Erinnerungsintervall *</label>
            <select name="reminder_interval" [(ngModel)]="deviceForm.reminder_interval" required class="form-control">
              @for (interval of reminderIntervals; track interval.value) {
                <option [value]="interval.value">{{ interval.label }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" name="reminder_enabled" [(ngModel)]="deviceForm.reminder_enabled" />
              <span>Email-Erinnerungen aktiviert</span>
            </label>
          </div>

          <div class="form-group">
            <label>Notizen</label>
            <textarea name="notes" [(ngModel)]="deviceForm.notes" class="form-control" rows="4"></textarea>
          </div>

          <div class="modal-actions">
            <button type="button" (click)="closeEditDeviceModal()" class="btn-secondary">Abbrechen</button>
            <button type="submit" [disabled]="deviceFormElem.invalid || isLoading" class="btn-primary">Aktualisieren</button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Modal: Edit User Email -->
  @if (showEditUserModal && editingUser) {
    <div class="modal-overlay" (click)="closeEditUserModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Email-Adresse Ã¤ndern</h2>
          <button (click)="closeEditUserModal()" class="btn-close">âœ•</button>
        </div>

        <div class="modal-body">
          <div class="form-info">
            <strong>Benutzer:</strong> {{ editingUser.first_name }} {{ editingUser.last_name }}
          </div>

          <div class="form-group">
            <label>Email-Adresse</label>
            <input type="email" [(ngModel)]="editingUser.email" class="form-control" />
          </div>
        </div>

        <div class="modal-actions">
          <button (click)="closeEditUserModal()" class="btn-secondary">Abbrechen</button>
          <button (click)="onUpdateUserEmail()" [disabled]="isLoading" class="btn-primary">Speichern</button>
        </div>
      </div>
    </div>
  }

  <!-- Modal: User Devices -->
  @if (showUserDevicesModal && (selectedUserId$ | async)) {
    <div class="modal-overlay" (click)="closeUserDevicesModal()">
      <div class="modal-content modal-xlarge" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>RettungsgerÃ¤te des Benutzers</h2>
          <button (click)="closeUserDevicesModal()" class="btn-close">âœ•</button>
        </div>

        <div class="modal-body">
          @if ((filteredDevices$ | async)?.length === 0) {
            <p class="text-muted">Keine GerÃ¤te gefunden</p>
          } @else {
            <div class="devices-list">
              @for (device of filteredDevices$ | async; track device.id) {
                <div class="device-item" [class]="getStatusClass(device)">
                  <div class="device-item-header">
                    <div>
                      <strong>{{ device.device_name }}</strong>
                      @if (device.serial_number) {
                        <span class="serial-small">SN: {{ device.serial_number }}</span>
                      }
                    </div>
                    <div class="device-item-actions">
                      <button (click)="openEditDevice(device); closeUserDevicesModal()" class="btn-icon-small">âœï¸</button>
                      <button (click)="deleteDevice(device)" class="btn-icon-small btn-danger">ğŸ—‘ï¸</button>
                    </div>
                  </div>
                  <div class="device-item-info">
                    <span>ğŸ“… {{ device.last_packed | date: 'dd.MM.yyyy' }}</span>
                    <span>ğŸ”” {{ getNextDueDate(device) | date: 'dd.MM.yyyy' }}</span>
                    <span>â±ï¸ {{ device.reminder_interval }}M</span>
                    <span class="status-badge-small">{{ getStatusText(device) }}</span>
                  </div>
                  @if (device.notes) {
                    <div class="device-item-notes">{{ device.notes }}</div>
                  }
                </div>
              }
            </div>
          }
        </div>

        <div class="modal-actions">
          <button (click)="closeUserDevicesModal()" class="btn-secondary">SchlieÃŸen</button>
        </div>
      </div>
    </div>
  }
</div>