<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <div>
        <h1>üö® Meine Rettungsger√§te</h1>
        @if (currentUser) {
          <p>Willkommen, {{ currentUser.vorname }} {{ currentUser.name }}</p>
        }
      </div>
      <div class="header-actions">
        <button (click)="openAccountSettings()" class="btn-secondary">‚öôÔ∏è Konto</button>
        <button (click)="logout()" class="btn-secondary">Abmelden</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="dashboard-content">
    @if (message) {
      <div [class]="'alert alert-' + messageType">
        {{ message }}
      </div>
    }

    <!-- Action Bar -->
    <div class="action-bar">
      <button (click)="openAddForm()" class="btn-primary">
        ‚ûï Neues Ger√§t hinzuf√ºgen
      </button>
    </div>

    <!-- Devices Grid -->
    @if (isLoadingDevices) {
      <div class="loading">Lade Ger√§te...</div>
    } @else if (devices.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üì¶</div>
        <h3>Noch keine Ger√§te registriert</h3>
        <p>F√ºgen Sie Ihr erstes Rettungsger√§t hinzu, um Erinnerungen zu erhalten.</p>
        <button (click)="openAddForm()" class="btn-primary">Jetzt hinzuf√ºgen</button>
      </div>
    } @else {
      <div class="devices-grid">
        @for (device of devices; track device.id) {
          <div class="device-card" [class]="getStatusClass(device)">
            <div class="device-header">
              <div>
                <h3>{{ device.name }}</h3>
                @if (device.serial_number) {
                  <span class="serial-number">SN: {{ device.serial_number }}</span>
                }
              </div>
              <div class="device-actions">
                <button (click)="openEditForm(device)" class="btn-icon" title="Bearbeiten">
                  ‚úèÔ∏è
                </button>
                <button (click)="deleteDevice(device)" class="btn-icon btn-danger" title="L√∂schen">
                  üóëÔ∏è
                </button>
              </div>
            </div>

            <div class="device-info">
              <div class="info-row">
                <span class="info-label">üìÖ Zuletzt gepackt:</span>
                <span class="info-value">{{ device.last_packed | date: 'dd.MM.yyyy' }}</span>
              </div>

              <div class="info-row">
                <span class="info-label">üîî N√§chste √úberpr√ºfung:</span>
                <span class="info-value">{{ getNextDueDate(device) | date: 'dd.MM.yyyy' }}</span>
              </div>

              <div class="info-row">
                <span class="info-label">‚è±Ô∏è Intervall:</span>
                <span class="info-value">{{ device.reminder_interval }} Monate</span>
              </div>

              <div class="info-row">
                <span class="info-label">üìß Erinnerung:</span>
                <span class="info-value">
                  @if (device.reminder_enabled) {
                    <span class="badge-active">Aktiviert</span>
                  } @else {
                    <span class="badge-inactive">Deaktiviert</span>
                  }
                </span>
              </div>

              @if (device.notes) {
                <div class="info-row notes-row">
                  <span class="info-label">üìù Notizen:</span>
                  <span class="info-value notes-text">{{ device.notes }}</span>
                </div>
              }

              @if (device.last_reminder) {
                <div class="info-row">
                  <span class="info-label">üì¨ Letzte Erinnerung:</span>
                  <span class="info-value">{{ device.last_reminder | date: 'dd.MM.yyyy' }}</span>
                </div>
              }
            </div>

            <div class="device-status">
              <span class="status-badge">{{ getStatusText(device) }}</span>
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Modal for Add/Edit Device -->
  @if (showAddForm) {
    <div class="modal-overlay" (click)="closeForm()">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ editingDevice ? 'Ger√§t bearbeiten' : 'Neues Ger√§t hinzuf√ºgen' }}</h2>
          <button (click)="closeForm()" class="btn-close">‚úï</button>
        </div>

        <form (ngSubmit)="onSubmit()" #deviceFormElem="ngForm">
          <div class="form-group">
            <label for="name">Ger√§tename *</label>
            <input
              type="text"
              id="name"
              name="name"
              [(ngModel)]="deviceForm.name"
              required
              #name="ngModel"
              class="form-control"
              placeholder="z.B. Notfallrucksack, Erste-Hilfe-Koffer"
            />
            @if (name.invalid && name.touched) {
              <div class="error-text">Ger√§tename ist erforderlich</div>
            }
          </div>

          <div class="form-group">
            <label for="serial_number">Seriennummer</label>
            <input
              type="text"
              id="serial_number"
              name="serial_number"
              [(ngModel)]="deviceForm.serial_number"
              class="form-control"
              placeholder="z.B. ABC-123456"
            />
          </div>

          <div class="form-group">
            <label for="last_packed">Zuletzt gepackt *</label>
            <input
              type="date"
              id="last_packed"
              name="last_packed"
              [(ngModel)]="deviceForm.last_packed"
              required
              #lastPacked="ngModel"
              class="form-control"
            />
            @if (lastPacked.invalid && lastPacked.touched) {
              <div class="error-text">Datum ist erforderlich</div>
            }
          </div>

          <div class="form-group">
            <label for="reminder_interval">Erinnerungsintervall *</label>
            <select
              id="reminder_interval"
              name="reminder_interval"
              [(ngModel)]="deviceForm.reminder_interval"
              required
              class="form-control"
            >
              @for (interval of reminderIntervals; track interval.value) {
                <option [value]="interval.value">{{ interval.label }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                name="reminder_enabled"
                [(ngModel)]="deviceForm.reminder_enabled"
              />
              <span>Email-Erinnerungen aktiviert</span>
            </label>
            <small class="form-hint">
              Wenn aktiviert, erhalten Sie automatisch Erinnerungen alle {{ deviceForm.reminder_interval }} Monate
            </small>
          </div>

          <div class="form-group">
            <label for="notes">Notizen</label>
            <textarea
              id="notes"
              name="notes"
              [(ngModel)]="deviceForm.notes"
              class="form-control"
              rows="4"
              placeholder="Zus√§tzliche Informationen, Checkliste, etc."
            ></textarea>
          </div>

          <div class="modal-actions">
            <button type="button" (click)="closeForm()" class="btn-secondary">
              Abbrechen
            </button>
            <button 
              type="submit" 
              [disabled]="deviceFormElem.invalid || isLoading"
              class="btn-primary"
            >
              @if (isLoading) {
                <span>Wird gespeichert...</span>
              } @else {
                <span>{{ editingDevice ? 'Aktualisieren' : 'Hinzuf√ºgen' }}</span>
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Modal for Account Settings -->
  @if (showAccountSettings) {
    <div class="modal-overlay" (click)="closeAccountSettings()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>‚öôÔ∏è Kontoeinstellungen</h2>
          <button (click)="closeAccountSettings()" class="btn-close">‚úï</button>
        </div>

        <div class="account-settings">
          <div class="setting-section">
            <h3>Benutzerdaten</h3>
            @if (currentUser) {
              <p><strong>Name:</strong> {{ currentUser.vorname }} {{ currentUser.name }}</p>
              <p><strong>Email:</strong> {{ currentUser.email }}</p>
              <p><strong>Status:</strong> 
                @if (currentUser.is_active) {
                  <span class="badge-active">Aktiv</span>
                } @else {
                  <span class="badge-inactive">Deaktiviert</span>
                }
              </p>
            }
          </div>

          <div class="setting-section danger-zone">
            <h3>‚ö†Ô∏è Gefahrenbereich</h3>
            
            <div class="danger-action">
              <div>
                <strong>Konto deaktivieren</strong>
                <p>Sie k√∂nnen sich danach nicht mehr anmelden. Ihre Daten bleiben erhalten.</p>
              </div>
              <button (click)="deactivateAccount()" class="btn-warning">
                Deaktivieren
              </button>
            </div>

            <div class="danger-action">
              <div>
                <strong>Konto l√∂schen</strong>
                <p>L√∂scht Ihr Konto und ALLE Ger√§te permanent. Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</p>
              </div>
              <button (click)="deleteAccount()" class="btn-danger">
                Konto l√∂schen
              </button>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button (click)="closeAccountSettings()" class="btn-secondary">
            Schlie√üen
          </button>
        </div>
      </div>
    </div>
  }
</div>